(function(){var h=function(b){var c=0;if(0==b.length)return c;for(var a=0;a<b.length;a++)char=b.charCodeAt(a),c=(c<<5)-c+char,c&=c;return Math.abs(4*c).toString(36).slice(0,6)},p=function(b){_self=this;this.token=null;this.get=function(){return b.getAppSettings().then(function(b){if(!b)return null;b=h(b.app_id+b.username+b.publisher_id);b=window.localStorage.getItem(b);b=JSON.parse(b);if(!b)return null;if(b.expires<=(new Date).valueOf())_self.unset();else return b.token||null},function(){return null})};
this.set=function(c){return b.getAppSettings().then(function(a){a=h(a.app_id+a.username+a.publisher_id);var b="";"object"===typeof c&&(b=JSON.stringify({token:c.authToken,expires:(new Date).valueOf()+1E3*Number(c.expiresIn)}));b?window.localStorage.setItem(a,b):window.localStorage.removeItem(a)})};this.unset=function(){_self.token=null;_self.set()}},u=function(){var b=this;this.request=function(a){a&&"object"===typeof a||(a={});return new Promise(function(b,c){if(!a.url)return c("Please provide an url");
var f=a.method||"GET",e=a.url,l=a.headers||{},g=a.data||null,d=a.query||{},h=[200,201,202,203,204,205,206,207,208,226],m="?",k;for(k in d)m+=k+"="+d[k]+"&";d=new XMLHttpRequest;d.open(f,e+m);for(var n in l)d.setRequestHeader(n,l[n]);d.addEventListener("load",function(a){4===a.target.readyState&&-1!==h.indexOf(a.target.status)?b(a.target.response):c(a.target.response)});d.addEventListener("error",function(a){c()});d.send(g)})};this.appSettings=this.appConfig=null;this.getAppConfig=function(a){if(!b.appConfig||
a)b.appConfig=b.request({url:"app.xml"}).then(function(a){return(new DOMParser).parseFromString(a,"text/xml")},function(){return null});return b.appConfig};this.getAppSettings=function(a){if(!b.appSettings||a)b.appSettings=b.request({url:"app_settings.json"}).then(function(a){return JSON.parse(a)},function(){return null});return b.appSettings};var c=new p(b);this.getToken=function(){c.get().then(function(b){b&&(a=b)});var a=null,f=null;return function(g){var q=function(){return b.getAppSettings().then(function(a){return b.request({method:"POST",
url:(a.server_host_name||"")+"/api/v1/auth/tokens",headers:{Authorization:"SCAuth authToken=null","Content-Type":"application/x-www-form-urlencoded"},data:r({appId:a.app_id,publisherId:a.publisher_id,appOwnerPublisherID:a.publisher_id,apiKey:a.sc_api_key,appOwnerUsername:a.username})}).then(function(a){a=JSON.parse(a);c.set(a);return c.get()},function(){return null})})};if(!g&&a)return Promise.resolve(a);f||(f=q().then(function(b){a=b;f=null;return b}));return f}}();this.ApiRequest=function(a,c,g){rawConf=
a;if(!a)return Promise.reject("Invalid arguments");c&&"function"===typeof c||(c=function(){});return Promise.all([b.getAppSettings(),b.getToken()]).then(function(c){var e=c[0];c=c[1];a.url&&"string"===typeof a.url&&(a.url=a.url.replace(/\{\{host\}\}/,e.server_host_name).replace(/\{\{.*\}\}/,""));a.headers||(a.headers={});a.headers.Authorization="SCAuth authToken="+c;a.headers["Content-Type"]||(a.headers["Content-Type"]="application/x-www-form-urlencoded");a.query||(a.query={});a.query.appid=e.app_id;
a.query.pageid=t();a.query.publisherid=e.publisher_id;a.query.apiKey=e.sc_api_key;a.query.username=e.username;a.method||(a.method="GET");return b.request(a).then(function(a){try{a=JSON.parse(a)}catch(v){}return a},function(a){a=JSON.parse(a);return-1===["invalidAuthToken","authTokenExpired"].indexOf(((((a||{}).error||{}).errors||[])[0]||{}).reason||"unknown")||g?a:b.getToken(!0).then(function(){return b.ApiRequest(rawConf,void 0,!0)})})})["catch"](function(a){console.warn(a)})}},r=function(b){var c=
[],a;for(a in b)b.hasOwnProperty(a)&&c.push(encodeURIComponent(a)+"="+encodeURIComponent(b[a]));return c.join("&")},t=function(){var b=window.location.pathname.split("/");return b.splice(b.length-1,1)[0]||""};define(function(b,c,a){b=new u;a.exports={request:b.request,ApiRequest:b.ApiRequest,getAppConfig:b.getAppConfig,getAppSettings:b.getAppSettings,raw:b}})})();